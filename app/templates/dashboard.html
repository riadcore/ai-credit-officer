<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Credit Officer Dashboard</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow:0 10px 25px rgba(2,6,23,.06);
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --green:#15803d;
      --red:#b91c1c;
      --amber:#b45309;
      --pill:#eef2ff;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1180px;margin:18px auto;padding:0 16px}
    .topbar{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:var(--shadow);
      gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:26px;height:26px;border-radius:50%;
      display:grid;place-items:center;
      background:linear-gradient(135deg,#60a5fa,#1d4ed8);
      color:#fff;font-weight:700;font-size:13px;
    }
    .brand h1{font-size:14px;margin:0;line-height:1}
    .brand .sub{font-size:11px;color:var(--muted);margin-top:2px}
    .nav{display:flex;gap:8px;align-items:center}
    .nav a{
      text-decoration:none;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--text);
      background:#fff;
    }
    .nav a.primary{
      background:var(--blue);
      border-color:var(--blue);
      color:#fff;
    }

    .header{
      margin:16px 2px 10px;
    }
    .header h2{margin:0;font-size:18px}
    .header p{margin:6px 0 0;color:var(--muted);font-size:12px}

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h3{margin:0 0 10px;font-size:13px}
    .card .hint{color:var(--muted);font-size:11px;margin-top:-6px;margin-bottom:10px}

    .formgrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .field label{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin-bottom:5px;
    }
    input, select{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      outline:none;
      background:#fff;
      font-size:12px;
    }
    input:focus, select:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .rowspan{grid-column:1/-1}
    .btnrow{display:flex;gap:8px;margin-top:10px;align-items:center}
    button{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
      cursor:pointer;
    }
    button.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    button.primary:hover{background:var(--blue2)}
    button.ghost{background:#fff}
    .tiny{font-size:11px;color:var(--muted)}
    .error{color:var(--red);font-size:11px;margin-top:8px}

    .resultBox{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
      background:#fff;
    }
    .badge.approve{background:rgba(21,128,61,.08);border-color:rgba(21,128,61,.25);color:var(--green)}
    .badge.reject{background:rgba(185,28,28,.08);border-color:rgba(185,28,28,.25);color:var(--red)}
    .badge.neutral{background:#f8fafc;color:#0f172a}
    .kvs{margin-top:10px;display:grid;gap:8px}
    .kv{
      display:flex;justify-content:space-between;gap:10px;
      font-size:12px;
      padding:8px 10px;border:1px solid var(--border);
      border-radius:12px;background:#fff;
    }
    .kv span:first-child{color:var(--muted)}
    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      background:var(--pill);
      border:1px solid #c7d2fe;
      color:#3730a3;
    }
    .pill.ok{background:rgba(21,128,61,.08);border-color:rgba(21,128,61,.2);color:var(--green)}
    .pill.warn{background:rgba(180,83,9,.08);border-color:rgba(180,83,9,.2);color:var(--amber)}
    .pill.bad{background:rgba(185,28,28,.08);border-color:rgba(185,28,28,.2);color:var(--red)}

    /* SHAP */
    .shapHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px
    }
    .legend{display:flex;gap:12px;font-size:11px;color:var(--muted);align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.g{background:var(--green)}
    .dot.r{background:var(--red)}
    .shapList{display:grid;gap:10px;margin-top:10px}
    .shapRow{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
      display:grid;
      grid-template-columns: 1.2fr .25fr 1.4fr;
      gap:10px;
      align-items:center;
    }
    .shapName{font-size:12px;font-weight:600}
    .shapPct{font-size:12px;color:var(--muted);text-align:right;min-width:46px}
    .bar{
      height:16px;border-radius:999px;border:1px solid var(--border);
      background:#f1f5f9;position:relative;overflow:hidden;
    }
    .fill{
      position:absolute;top:0;bottom:0;border-radius:999px;
      width:0%;
      left:50%;
      transform:translateX(-50%);
    }
    .fill.g{background:rgba(21,128,61,.95)}
    .fill.r{background:rgba(185,28,28,.95)}
    .shapSummary{
      margin-top:10px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:10px;
      font-size:12px;
      color:#0f172a;
    }
    .muted{color:var(--muted)}

    /* Chat */
    .chatTop{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      margin-bottom:8px;
    }
    .chatBox{
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      padding:10px;
    }
    .chatPinned{
      font-size:11px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
      margin:6px 0 8px;
    }
    .chatPinned .pill{font-size:10px}
    .messages{
      height:210px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fbfdff;
    }
    .msg{margin:0 0 10px;font-size:12px;line-height:1.45}
    .msg.user{color:#0f172a}
    .msg.bot{color:#0f172a}
    .bubble{
      display:inline-block;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      max-width:92%;
      white-space:pre-wrap;
    }
    .bubble.bot{background:#f8fafc}
    .bubble.user{background:#eef2ff;border-color:#c7d2fe}
    .quick{
      display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;
    }
    .quick button{
      padding:7px 10px;
      font-size:11px;
      border-radius:999px;
      background:#fff;
    }
    .composer{
      display:flex;gap:8px;margin-top:10px;
    }
    .composer input{flex:1}
    .composer button{width:86px}

    /* Model perf + admin */
    .twoCol{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .spark{
      height:48px;
      border:1px solid var(--border);
      border-radius:12px;
      background:linear-gradient(180deg,#fff,#f8fafc);
      display:flex;
      align-items:flex-end;
      padding:6px;
      gap:4px;
    }
    .spark span{
      display:block;
      width:100%;
      background:#cbd5e1;
      border-radius:6px 6px 2px 2px;
      height:16px;
    }
    .adminRow{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .adminRow input[type="file"]{padding:8px}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
    }
    th,td{padding:8px 9px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:11px;color:var(--muted);background:#f8fafc}
    tr:last-child td{border-bottom:none}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .actions button{padding:6px 10px;font-size:11px}
    .danger{border-color:rgba(185,28,28,.25);color:var(--red)}
    .danger:hover{background:rgba(185,28,28,.06)}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo">A</div>
        <div>
          <h1>AI Credit Officer</h1>
          <div class="sub">Explainable decisions • Compliance-ready</div>
        </div>
      </div>
      <div class="nav">
        <a class="primary" href="/dashboard">Dashboard</a>
        <a href="/history">History</a>
      </div>
    </div>

    <div class="header">
      <h2>AI Credit Officer Dashboard</h2>
      <p>Score a borrower, view explainable SHAP factors, and ask the chatbot why the decision happened.</p>
    </div>

    <div class="grid">

      <!-- LEFT COLUMN -->
      <div>

        <div class="card">
          <h3>Borrower Input</h3>
          <div class="hint">Provide the borrower features and score the credit decision.</div>

          <div class="formgrid">
            <div class="field">
              <label>Borrower ID</label>
              <input id="borrower_id" value="B001" />
            </div>
            <div class="field">
              <label>Monthly Income</label>
              <input id="monthly_income" type="number" value="50000" />
            </div>

            <div class="field">
              <label>Monthly Expense</label>
              <input id="monthly_expense" type="number" value="25000" />
            </div>
            <div class="field">
              <label>Age</label>
              <input id="age" type="number" value="30" />
            </div>

            <div class="field">
              <label>Has Smartphone?</label>
              <select id="has_smartphone">
                <option value="1" selected>Yes</option>
                <option value="0">No</option>
              </select>
            </div>
            <div class="field">
              <label>Has Mobile Wallet?</label>
              <select id="has_wallet">
                <option value="1" selected>Yes</option>
                <option value="0">No</option>
              </select>
            </div>

            <div class="field">
              <label>Avg Wallet Balance</label>
              <input id="avg_wallet_balance" type="number" value="3000" />
            </div>
            <div class="field">
              <label>On-Time Payment Ratio</label>
              <input id="on_time_payment_ratio" type="number" step="0.01" value="0.85" />
              <div class="tiny">0.00 to 1.00</div>
            </div>

            <div class="field rowspan">
              <label>Num Loans Taken</label>
              <input id="num_loans_taken" type="number" value="2" />
            </div>
          </div>

          <div class="btnrow">
            <button class="primary" id="scoreBtn">Score Borrower</button>
            <button class="ghost" id="resetBtn">Restart</button>
            <span class="tiny" id="pinInfo"></span>
          </div>

          <div class="error" id="errBox" style="display:none"></div>
        </div>

        <div class="card">
          <h3>Result</h3>
          <div class="hint">Decision + explanation (non-black-box).</div>

          <div class="resultBox">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
              <div>
                <div class="tiny muted">Decision Output</div>
                <div style="margin-top:6px">
                  <span id="decisionBadge" class="badge neutral">—</span>
                </div>
              </div>
              <div class="tiny muted" id="decisionMeta">Score a borrower to see the result.</div>
            </div>

            <div class="kvs">
              <div class="kv">
                <span>Risk score (PD)</span>
                <span id="riskScore">—</span>
              </div>
              <div class="kv">
                <span>Explanation</span>
                <span id="explanation" style="text-align:right;max-width:60%">—</span>
              </div>
              <div class="kv">
                <span>Fraud Risk</span>
                <span>
                  <span id="fraudScore">—</span>
                  <span id="fraudLabel" class="pill" style="margin-left:6px">—</span>
                </span>
              </div>
              <div class="kv">
                <span>Flags</span>
                <span id="flags">None</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="shapHead">
            <div>
              <h3 style="margin:0">SHapley Additive exPlanations (SHAP)</h3>
              <div class="hint" style="margin:6px 0 0">Relative contribution of each feature to the credit decision</div>
            </div>
            <div class="legend">
              <span class="dot g"></span> Decreases credit risk
              <span class="dot r"></span> Increases credit risk
            </div>
          </div>

          <div class="resultBox">
            <div class="tiny muted" style="margin-bottom:8px">What Affected the Credit Decision?</div>
            <div id="shapRows" class="shapList">
              <div class="tiny muted">Score a borrower to see top factors.</div>
            </div>
            <div id="shapSummary" class="shapSummary muted">—</div>
          </div>
        </div>

      </div>

      <!-- RIGHT COLUMN -->
      <div>

        <div class="card">
          <h3>AI Credit Officer Chat</h3>
          <div class="hint">Ask why the decision happened (grounded on ExplainChain + SHAP)</div>

          <div class="chatTop">
            <select id="chatLang" style="max-width:140px">
              <option value="en" selected>English</option>
              <option value="bn">বাংলা</option>
            </select>

            <select id="chatMode" style="max-width:160px">
              <option value="borrower" selected>Borrower</option>
              <option value="officer">Loan Officer</option>
              <option value="auditor">Auditor</option>
            </select>
          </div>

          <div class="chatBox">
            <div class="chatPinned">
              <span class="muted">Pinned to Decision ID:</span>
              <span id="pinnedDecisionLabel" class="pill">—</span>
              <button id="pinLatestBtn" title="Pin to latest decision for this borrower">Pin latest</button>
            </div>

            <div id="messages" class="messages">
              <p class="msg bot"><span class="bubble bot" id="chatWelcome">Hi! Score a borrower first. Then ask questions grounded on the pinned decision.</span></p>
            </div>

            <div class="quick">
              <button data-q="Why this decision?">Why this decision?</button>
              <button data-q="Which top 3 factors influenced the decision most?">Top 3 factors</button>
              <button data-q="How can the borrower improve the approval chance?">How to improve?</button>
              <button data-q="Write an auditor-ready summary of the decision with SHAP percentages.">Auditor summary</button>
            </div>

            <div class="composer">
              <input id="chatInput" placeholder="Type your question..." />
              <button class="primary" id="sendBtn">Send</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Model Performance</h3>
          <div class="hint">Quick snapshot of current production model quality.</div>

          <div class="twoCol">
            <div class="kv"><span>AUC</span><span id="m_auc">—</span></div>
            <div class="kv"><span>Gini</span><span id="m_gini">—</span></div>
          </div>

          <div style="margin-top:10px" class="resultBox">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="tiny muted">Drift score</div>
                <div style="font-size:16px;font-weight:700" id="m_drift">0.00</div>
              </div>
              <span class="pill ok" id="m_state">Stable</span>
            </div>

            <div class="spark" id="spark">
              <span style="height:10px"></span><span style="height:16px"></span><span style="height:12px"></span><span style="height:18px"></span>
              <span style="height:14px"></span><span style="height:22px"></span><span style="height:12px"></span><span style="height:18px"></span>
              <span style="height:14px"></span><span style="height:20px"></span><span style="height:12px"></span><span style="height:18px"></span>
            </div>

            <div class="tiny muted" style="margin-top:8px">
              Stable (0.00–0.20) &nbsp; Monitor (0.21–0.50) &nbsp; Drift (0.51–1.00)
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Model Maintenance (Admin)</h3>
          <div class="hint">Upload training CSV, retrain, deploy, download, or delete model versions.</div>

          <div class="adminRow">
            <input id="csvFile" type="file" accept=".csv" />
            <button id="uploadCsvBtn">Upload CSV</button>
            <button id="retrainBtn" class="primary">Retrain</button>
            <span class="tiny muted" id="adminStatus">—</span>
          </div>

          <div style="margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Version</th>
                  <th>Time</th>
                  <th>AUC</th>
                  <th>Active</th>
                  <th style="width:220px">Actions</th>
                </tr>
              </thead>
              <tbody id="historyRows">
                <tr><td colspan="6" class="muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script>
    // ============================================================
    // Global pinned decision (THIS is the key to fixing mismatch)
    // ============================================================
    let pinnedDecisionId = null;
    let pinnedBorrowerId = null;

    const $ = (id) => document.getElementById(id);

    function showError(msg){
      const el = $("errBox");
      el.style.display = "block";
      el.textContent = msg;
    }
    function clearError(){
      const el = $("errBox");
      el.style.display = "none";
      el.textContent = "";
    }

    function setPinned(decisionId, borrowerId){
      pinnedDecisionId = decisionId ?? null;
      pinnedBorrowerId = borrowerId ?? null;
      $("pinnedDecisionLabel").textContent = pinnedDecisionId ? String(pinnedDecisionId) : "—";
      $("pinInfo").textContent = pinnedDecisionId ? `Pinned decision_id=${pinnedDecisionId}` : "";
    }

    function badgeDecision(decisionText){
      const b = $("decisionBadge");
      b.className = "badge neutral";
      const v = (decisionText || "").toUpperCase();
      if(v.includes("APPROVE")){ b.className = "badge approve"; b.textContent = "APPROVE"; return; }
      if(v.includes("REJECT")){ b.className = "badge reject"; b.textContent = "REJECT"; return; }
      b.textContent = decisionText || "—";
    }

    function fraudPill(label){
      const el = $("fraudLabel");
      el.className = "pill";
      const v = (label || "").toUpperCase();
      if(v.includes("NORMAL") || v.includes("LOW")) el.classList.add("ok");
      else if(v.includes("MED")) el.classList.add("warn");
      else if(v.includes("HIGH") || v.includes("RISK")) el.classList.add("bad");
      else el.classList.add("ok");
      el.textContent = label || "—";
    }

    function prettyFeature(name){
      if(!name) return "—";
      // convert snake_case to Title Case
      return String(name)
        .replace(/_/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function renderShap(topFactors){
      const container = $("shapRows");
      container.innerHTML = "";

      if(!Array.isArray(topFactors) || topFactors.length === 0){
        container.innerHTML = `<div class="tiny muted">No SHAP factors found.</div>`;
        $("shapSummary").textContent = "—";
        return;
      }

      // Use pct_influence if present (your backend computes it if missing)
      const list = topFactors.slice(0, 3);

      list.forEach((f) => {
        const pct = Number(f.pct_influence ?? f.pct ?? 0);
        const direction = (f.direction || "").toLowerCase();
        const name = prettyFeature(f.feature || f.name);

        // draw centered bar, green for decreases risk, red for increases
        const isIncrease = direction.includes("increase") || direction.includes("risk+") || direction.includes("pos") || direction === "up";
        const cls = isIncrease ? "r" : "g";

        const row = document.createElement("div");
        row.className = "shapRow";
        row.innerHTML = `
          <div class="shapName">${name}</div>
          <div class="shapPct">${isFinite(pct) ? pct.toFixed(0) : 0}%</div>
          <div class="bar"><div class="fill ${cls}" style="width:${Math.min(Math.max(pct,0),100)}%"></div></div>
        `;
        container.appendChild(row);
      });

      const best = list[0];
      const bestName = prettyFeature(best.feature || best.name);
      const bestVal = best.value;
      const bestDir = (best.direction || "").toLowerCase();
      const bestIsIncrease = bestDir.includes("increase") || bestDir.includes("pos") || bestDir.includes("risk+") || bestDir === "up";

      $("shapSummary").innerHTML = `
        <div><b>Overall</b>, your most influential factor was "<b>${bestName}</b>".</div>
        <div class="muted" style="margin-top:6px">
          ${best.feature || best.name}: value ${bestVal ?? "—"} ${bestIsIncrease ? "increases" : "decreases"} the default risk.
        </div>
      `;
    }

    // ============================================================
    // Score Borrower (pins decision_id + renders SHAP)
    // ============================================================
    async function scoreBorrower(){
      clearError();
      const payload = {
        borrower_id: $("borrower_id").value.trim(),
        monthly_income: Number($("monthly_income").value),
        monthly_expense: Number($("monthly_expense").value),
        age: Number($("age").value),
        has_smartphone: Number($("has_smartphone").value),
        has_wallet: Number($("has_wallet").value),
        avg_wallet_balance: Number($("avg_wallet_balance").value),
        on_time_payment_ratio: Number($("on_time_payment_ratio").value),
        num_loans_taken: Number($("num_loans_taken").value),
      };

      try{
        const res = await fetch("/decision", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const t = await res.text();
          throw new Error(t || "Decision request failed");
        }
        const data = await res.json();

        // ✅ CRITICAL: pin the decision_id returned by backend
        setPinned(data.decision_id, data.borrower_id || payload.borrower_id);

        badgeDecision(data.decision);
        $("riskScore").textContent = (data.risk_score ?? "—");
        $("explanation").textContent = (data.explanation ?? "—");
        $("fraudScore").textContent = (data.fraud_score ?? "—");
        fraudPill(data.fraud_label ?? "—");
        $("flags").textContent = (data.flags && data.flags.length) ? data.flags.join(", ") : "None";
        $("decisionMeta").textContent = pinnedDecisionId ? `decision_id=${pinnedDecisionId}` : "—";

        renderShap(data.top_factors || data.shap_factors || []);

        // Optional: nudge chat UI
        if(pinnedDecisionId){
          appendBot(`Pinned to Decision ID ${pinnedDecisionId}. Ask: "Why this decision?"`);
        }
      }catch(e){
        showError(String(e.message || e));
      }
    }

    function resetForm(){
      clearError();
      badgeDecision("—");
      $("riskScore").textContent = "—";
      $("explanation").textContent = "—";
      $("fraudScore").textContent = "—";
      fraudPill("—");
      $("flags").textContent = "None";
      $("decisionMeta").textContent = "Score a borrower to see the result.";
      $("shapRows").innerHTML = `<div class="tiny muted">Score a borrower to see top factors.</div>`;
      $("shapSummary").textContent = "—";
      setPinned(null, null);
    }

    // ============================================================
    // Chat (ALWAYS send pinnedDecisionId)
    // ============================================================
    function appendUser(text){
      const box = $("messages");
      const p = document.createElement("p");
      p.className = "msg user";
      p.innerHTML = `<span class="bubble user">${escapeHtml(text)}</span>`;
      box.appendChild(p);
      box.scrollTop = box.scrollHeight;
    }
    function appendBot(text){
      const box = $("messages");
      const p = document.createElement("p");
      p.className = "msg bot";
      p.innerHTML = `<span class="bubble bot">${escapeHtml(text)}</span>`;
      box.appendChild(p);
      box.scrollTop = box.scrollHeight;
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    async function sendChat(message){
      const msg = (message ?? $("chatInput").value).trim();
      if(!msg) return;

      appendUser(msg);
      $("chatInput").value = "";

      const borrowerId = $("borrower_id").value.trim();
      const lang = $("chatLang").value;
      const mode = $("chatMode").value;

      // ✅ CRITICAL: always include decision_id when available
      const payload = {
        message: msg,
        borrower_id: borrowerId || null,
        decision_id: pinnedDecisionId,   // <-- THIS fixes mismatch
        language: lang,
        mode: mode
      };

      try{
        const res = await fetch("/chat", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          const t = await res.text();
          throw new Error(t || "Chat request failed");
        }

        const data = await res.json();

        // If backend returns a decision_id, keep UI pinned to it
        if(data && data.decision_id){
          setPinned(data.decision_id, data.borrower_id || borrowerId);
        }

        appendBot(data.answer || "—");
      }catch(e){
        appendBot("⚠️ /chat failed: " + (e.message || e));
      }
    }

    async function pinLatest(){
      // This simply re-scores nothing; it pins to latest decision in DB for borrower_id via /chat fallback.
      // Better approach: expose a /latest_decision endpoint. Since we don't have that, we'll do a tiny chat call.
      const borrowerId = $("borrower_id").value.trim();
      if(!borrowerId){
        appendBot("Please enter borrower_id first.");
        return;
      }

      try{
        const res = await fetch("/chat", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            message: "Show pinned decision id only.",
            borrower_id: borrowerId,
            decision_id: null,
            language: "en",
            mode: "auditor"
          })
        });
        const data = await res.json();
        if(data && data.decision_id){
          setPinned(data.decision_id, data.borrower_id || borrowerId);
          appendBot(`Pinned to latest decision_id=${data.decision_id} for borrower ${borrowerId}.`);
        }else{
          appendBot("No decision found yet. Please score a borrower first.");
        }
      }catch(e){
        appendBot("⚠️ Pin latest failed: " + (e.message || e));
      }
    }

    // ============================================================
    // Model Performance + History (best effort)
    // ============================================================
    function setDriftState(score){
      const s = Number(score || 0);
      const el = $("m_state");
      el.className = "pill";
      if(s <= 0.20){ el.classList.add("ok"); el.textContent = "Stable"; }
      else if(s <= 0.50){ el.classList.add("warn"); el.textContent = "Monitor"; }
      else { el.classList.add("bad"); el.textContent = "Drift"; }
    }

    async function loadMetrics(){
      try{
        const res = await fetch("/metrics");
        if(!res.ok) return;
        const m = await res.json();
        $("m_auc").textContent = (m.auc ?? "—");
        $("m_gini").textContent = (m.gini ?? "—");
        $("m_drift").textContent = (m.drift_score ?? 0).toFixed ? (Number(m.drift_score).toFixed(2)) : (m.drift_score ?? "0.00");
        setDriftState(m.drift_score ?? 0);
      }catch(_){}
    }

    function renderHistory(rows){
      const tbody = $("historyRows");
      tbody.innerHTML = "";
      if(!Array.isArray(rows) || rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">No versions found.</td></tr>`;
        return;
      }

      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${escapeHtml(r.version ?? r.id ?? "—")}</td>
          <td>${escapeHtml(r.time ?? r.created_at ?? "—")}</td>
          <td>${escapeHtml(r.auc ?? "—")}</td>
          <td>${r.active ? "✅" : "—"}</td>
          <td>
            <div class="actions">
              <button onclick="deployVersion('${escapeHtml(r.version ?? r.id ?? "")}')">Deploy</button>
              <button onclick="downloadVersion('${escapeHtml(r.version ?? r.id ?? "")}')">Download</button>
              <button class="danger" onclick="deleteVersion('${escapeHtml(r.version ?? r.id ?? "")}')">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadModelHistory(){
      try{
        const res = await fetch("/model_history");
        if(!res.ok) return;
        const data = await res.json();
        // support either {rows:[...]} or [...]
        renderHistory(data.rows || data || []);
      }catch(_){}
    }

    async function uploadCsv(){
      const f = $("csvFile").files[0];
      if(!f){ $("adminStatus").textContent = "Select a CSV file first."; return; }

      const fd = new FormData();
      fd.append("file", f);

      $("adminStatus").textContent = "Uploading…";
      try{
        const res = await fetch("/upload_csv", { method:"POST", body: fd });
        const t = await res.text();
        $("adminStatus").textContent = res.ok ? "CSV uploaded." : ("Upload failed: " + t);
      }catch(e){
        $("adminStatus").textContent = "Upload failed: " + (e.message || e);
      }
    }

    async function retrain(){
      $("adminStatus").textContent = "Retraining…";
      try{
        const res = await fetch("/retrain", { method:"POST" });
        const t = await res.text();
        $("adminStatus").textContent = res.ok ? "Retrain complete. New version created." : ("Retrain failed: " + t);
        await loadMetrics();
        await loadModelHistory();
      }catch(e){
        $("adminStatus").textContent = "Retrain failed: " + (e.message || e);
      }
    }

    // These are best-effort endpoints (only work if your backend exposes them)
    async function deployVersion(version){
      if(!version) return;
      $("adminStatus").textContent = "Deploying…";
      try{
        const res = await fetch("/deploy", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ version })
        });
        const t = await res.text();
        $("adminStatus").textContent = res.ok ? "Deployed." : ("Deploy failed: " + t);
        await loadModelHistory();
      }catch(e){
        $("adminStatus").textContent = "Deploy failed: " + (e.message || e);
      }
    }
    async function downloadVersion(version){
      if(!version) return;
      // open in new tab (if backend supports it)
      window.open(`/download?version=${encodeURIComponent(version)}`, "_blank");
    }
    async function deleteVersion(version){
      if(!version) return;
      if(!confirm("Delete this version?")) return;
      $("adminStatus").textContent = "Deleting…";
      try{
        const res = await fetch("/delete_version", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ version })
        });
        const t = await res.text();
        $("adminStatus").textContent = res.ok ? "Deleted." : ("Delete failed: " + t);
        await loadModelHistory();
      }catch(e){
        $("adminStatus").textContent = "Delete failed: " + (e.message || e);
      }
    }

    // expose to window for inline onclick
    window.deployVersion = deployVersion;
    window.downloadVersion = downloadVersion;
    window.deleteVersion = deleteVersion;

    // ============================================================
    // Wire events
    // ============================================================
    $("scoreBtn").addEventListener("click", scoreBorrower);
    $("resetBtn").addEventListener("click", resetForm);

    $("sendBtn").addEventListener("click", () => sendChat());
    $("chatInput").addEventListener("keydown", (e) => {
      if(e.key === "Enter") sendChat();
    });

    document.querySelectorAll(".quick button").forEach(btn => {
      btn.addEventListener("click", () => {
        const q = btn.getAttribute("data-q");
        sendChat(q);
      });
    });

    $("pinLatestBtn").addEventListener("click", pinLatest);

    $("uploadCsvBtn").addEventListener("click", uploadCsv);
    $("retrainBtn").addEventListener("click", retrain);

    // initial loads
    loadMetrics();
    loadModelHistory();
    setPinned(null, null);

    // light refresh
    setInterval(loadMetrics, 15000);
    setInterval(loadModelHistory, 30000);
  </script>
</body>
</html>
